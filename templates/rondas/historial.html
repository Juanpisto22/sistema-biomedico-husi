{% extends "base.html" %}

{% block title %}Historial de servicios - Gestión Biomédica{% endblock %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <h1 class="h4 mb-0">Historial de registros</h1>
    <div class="d-flex gap-2">
      <a href="{% url 'exportar_historial_excel' %}{% if request.GET.categoria %}?categoria={{ request.GET.categoria }}{% endif %}{% if request.GET.subservicio %}&subservicio={{ request.GET.subservicio }}{% endif %}" 
         class="btn btn-success btn-sm">
        <i class="fas fa-file-excel"></i> Excel
      </a>
      <a href="{% url 'exportar_historial_pdf' %}{% if request.GET.categoria %}?categoria={{ request.GET.categoria }}{% endif %}{% if request.GET.subservicio %}&subservicio={{ request.GET.subservicio }}{% endif %}" 
         class="btn btn-danger btn-sm">
        <i class="fas fa-file-pdf"></i> PDF
      </a>
      <a href="{% url 'panel_principal' %}" class="btn btn-outline-primary btn-sm">Volver al panel</a>
    </div>
  </div>

  <form method="get" class="card border-0 shadow-sm mb-4 p-3">
    <div class="row g-3">
      <div class="col-md-4">
        <label for="id_categoria" class="form-label">Categoría</label>
        <select name="categoria" id="id_categoria" class="form-select">
          <option value="">Todas</option>
          {% for clave, datos in categorias.items %}
            <option value="{{ clave }}" {% if request.GET.categoria == clave %}selected{% endif %}>{{ datos.titulo }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-5">
        <label for="id_subservicio" class="form-label">Servicio</label>
        <input
          type="text"
          name="subservicio"
          id="id_subservicio"
          class="form-control"
          value="{{ request.GET.subservicio|default:'' }}"
          placeholder="Filtrar por nombre de servicio"
        />
      </div>
      <div class="col-md-3 d-flex align-items-end gap-2">
        <button type="submit" class="btn btn-primary flex-grow-1">Aplicar filtros</button>
        <a href="{% url 'historial_servicios' %}" class="btn btn-outline-secondary">Limpiar</a>
      </div>
    </div>
  </form>

  <div class="card border-0 shadow-sm">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Fecha y hora</th>
            <th>Categoría</th>
            <th>Servicio</th>
            <th>Hallazgo / Eventos</th>
            <th>Firmas</th>
            <th>Estado</th>
            {% if perms.rondas.delete_roundentry or perms.rondas.delete_surgeryround or perms.rondas.change_roundentry or perms.rondas.change_surgeryround %}
            <th>Acciones</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% if registros %}
            {% for registro in registros %}
              <tr>
                <td>
                  <span class="fw-semibold">{{ registro.fecha_creacion|date:"d/m/Y" }}</span><br />
                  <span class="text-muted small">{{ registro.fecha_creacion|time:"H:i" }}</span>
                </td>
                <td>{{ registro.get_categoria_display }}</td>
                <td>{{ registro.subservicio }}</td>
                <td>
                  <div><strong>Hallazgo:</strong> {{ registro.hallazgo|default:"Sin registro" }}</div>
                  <div><strong>Eventos:</strong> {{ registro.eventos_seguridad|default:"Sin registro" }}</div>
                  {% if registro.placa_equipo %}
                    <div><strong>Placa:</strong> {{ registro.placa_equipo }}</div>
                  {% endif %}
                  {% if registro.orden_trabajo %}
                    <div><strong>Orden:</strong> {{ registro.orden_trabajo }}</div>
                  {% endif %}
                </td>
                <td>
                  <div class="d-flex flex-column gap-2">
                    {# Soporte para hasta 4 firmas de jefes almacenadas como JSON en firma_servicio #}
                    {% if registro.jefe_firmas %}
                      <div class="d-flex gap-2 flex-wrap">
                        {% for jefe in registro.jefe_firmas %}
                          <div>
                            <small class="text-muted">{{ jefe.name|default:"Jefe" }}</small><br>
                            <img src="{{ jefe.img }}" alt="Firma Jefe {{ forloop.counter }}" 
                                 class="img-thumbnail" style="max-width: 100px; max-height: 50px; cursor: pointer;"
                                 data-bs-toggle="modal" data-bs-target="#firmaModal{{ registro.id }}jefe{{ forloop.counter }}">
                          </div>
                        {% endfor %}
                      </div>
                    {% else %}
                      {% if registro.firma_servicio %}
                        <div>
                          <small class="text-muted">Servicio:</small><br>
                          <img src="{{ registro.firma_servicio }}" alt="Firma Servicio" 
                               class="img-thumbnail" style="max-width: 100px; max-height: 50px; cursor: pointer;"
                               data-bs-toggle="modal" data-bs-target="#firmaModal{{ registro.id }}servicio">
                        </div>
                      {% else %}
                        <small class="text-muted">Sin firma servicio</small>
                      {% endif %}
                    {% endif %}
                    
                    {% if registro.firma_ronda %}
                      <div>
                        <small class="text-muted">Ronda:</small><br>
                        <img src="{{ registro.firma_ronda }}" alt="Firma Ronda" 
                             class="img-thumbnail" style="max-width: 100px; max-height: 50px; cursor: pointer;"
                             data-bs-toggle="modal" data-bs-target="#firmaModal{{ registro.id }}ronda">
                      </div>
                    {% else %}
                      <small class="text-muted">Sin firma ronda</small>
                    {% endif %}
                  </div>
                </td>
                <td>
                  <span class="badge text-bg-info">Registro completo</span>
                </td>
                {% if perms.rondas.delete_roundentry or perms.rondas.delete_surgeryround or perms.rondas.change_roundentry or perms.rondas.change_surgeryround %}
                <td>
                  <div class="d-flex gap-1">
                    {% if registro.subservicio %}
                      <!-- Es un registro de servicio (RoundEntry) -->
                      {# Mostrar Editar si es creador o si tiene permiso de cambio (administrador) #}
                      {% if registro.usuario == user or perms.rondas.change_roundentry %}
                      <a href="{% url 'editar_registro' registro.id %}" 
                         class="btn btn-outline-primary btn-sm" 
                         title="Editar registro (solo el creador o administradores pueden editar)">
                        <i class="fas fa-edit"></i>
                      </a>
                      {% endif %}
                      {% if perms.rondas.delete_roundentry %}
                      <form method="post" action="{% url 'eliminar_registro' registro.id %}" 
                            onsubmit="return confirm('¿Está seguro que desea eliminar este registro? Esta acción no se puede deshacer.');" 
                            style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-danger btn-sm" title="Eliminar registro">
                          <i class="fas fa-trash"></i>
                        </button>
                      </form>
                      {% endif %}
                    {% else %}
                      <!-- Es un registro de cirugía (SurgeryRound) -->
                      {# Mostrar Editar para cirugías si es creador o tiene permiso de cambio #}
                      {% if registro.usuario == user or perms.rondas.change_surgeryround %}
                      <a href="{% url 'editar_registro_cirugia' registro.id %}" 
                         class="btn btn-outline-primary btn-sm" 
                         title="Editar registro de cirugía (solo el creador o administradores pueden editar)">
                        <i class="fas fa-edit"></i>
                      </a>
                      {% endif %}
                      {% if perms.rondas.delete_surgeryround %}
                      <form method="post" action="{% url 'eliminar_registro_cirugia' registro.id %}" 
                            onsubmit="return confirm('¿Está seguro que desea eliminar este registro de cirugía? Esta acción no se puede deshacer.');" 
                            style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-danger btn-sm" title="Eliminar registro de cirugía">
                          <i class="fas fa-trash"></i>
                        </button>
                      </form>
                      {% endif %}
                    {% endif %}
                  </div>
                </td>
                {% endif %}
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="{% if perms.rondas.delete_roundentry or perms.rondas.delete_surgeryround or perms.rondas.change_roundentry or perms.rondas.change_surgeryround %}7{% else %}6{% endif %}" class="text-center py-4 text-muted">No se encontraron registros con los filtros aplicados.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- Modales para visualizar firmas -->
  {% for registro in registros %}
    <!-- Modal Firma Servicio -->
    {% if registro.firma_servicio %}
  {# Modal Firma Servicio (única) #}
  <div class="modal fade" id="firmaModal{{ registro.id }}servicio" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Firma Encargado del Servicio</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center">
            <img src="{{ registro.firma_servicio }}" alt="Firma Servicio" class="img-fluid border">
            <div class="mt-3">
              <p><strong>Nombre:</strong> {{ registro.nombre_encargado_servicio }}</p>
              <p><strong>Servicio:</strong> {{ registro.subservicio }}</p>
              <p><strong>Fecha:</strong> {{ registro.fecha_creacion|date:"d/m/Y H:i" }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
    
  <!-- Modal Firma Ronda -->
    {% if registro.firma_ronda %}
    <div class="modal fade" id="firmaModal{{ registro.id }}ronda" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Firma Encargado de la Ronda</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center">
            <img src="{{ registro.firma_ronda }}" alt="Firma Ronda" class="img-fluid border">
            <div class="mt-3">
              <p><strong>Nombre:</strong> {{ registro.nombre_encargado_ronda }}</p>
              <p><strong>Servicio:</strong> {{ registro.subservicio }}</p>
              <p><strong>Fecha:</strong> {{ registro.fecha_creacion|date:"d/m/Y H:i" }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
    
    {# Si hay jefe_firmas, renderizar modales separados #}
    {% if registro.jefe_firmas %}
      {% for jefe in registro.jefe_firmas %}
        <div class="modal fade" id="firmaModal{{ registro.id }}jefe{{ forloop.counter }}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Firma {{ jefe.name|default:"Jefe" }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body text-center">
                <img src="{{ jefe.img }}" alt="Firma Jefe {{ forloop.counter }}" class="img-fluid border">
                <div class="mt-3">
                  <p><strong>Nombre:</strong> {{ jefe.name|default:"Jefe" }}</p>
                  <p><strong>Servicio:</strong> {{ registro.subservicio }}</p>
                  <p><strong>Fecha:</strong> {{ registro.fecha_creacion|date:"d/m/Y H:i" }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    {% endif %}
  {% endfor %}
{% endblock %}
