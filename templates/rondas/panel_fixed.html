{% extends "base.html" %}
{% load static %}

{% block title %}Panel principal - Gesti√≥n Biom√©dica{% endblock %}

{% block content %}
  <!-- T√≠tulo institucional -->
  <div class="text-center mb-4">
    <h1 class="display-4 fw-bold text-primary mb-2">Hospital Universitario San Ignacio</h1>
    <h2 class="h3 text-secondary mb-1">Gesti√≥n Biom√©dica</h2>
    <h3 class="h4 text-muted">Rondas Biom√©dicas</h3>
    <hr class="mx-auto" style="width: 200px; height: 3px; background: linear-gradient(90deg, #007bff, #6c757d);">
  </div>

  {% if es_dia_festivo %}
  <div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
    <div class="d-flex align-items-center">
      <i class="fas fa-calendar-alt fa-2x me-3 text-info"></i>
      <div>
        <h6 class="alert-heading mb-1">üéâ D√≠a Festivo Detectado</h6>
        <p class="mb-0">
          Hoy ({{ fecha_original|date:"d/m/Y" }}) es d√≠a festivo en Colombia. 
          <strong>Las rondas se han trasladado autom√°ticamente al {{ fecha_rondas|date:"l d/m/Y" }}</strong>.
        </p>
      </div>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  {% endif %}

  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <div>
      <h1 class="h4 mb-1">Panel de rondas - {{ dia_actual }}</h1>
      <p class="text-muted small mb-0">{{ ahora|date:"d 'de' F 'de' Y, H:i" }}</p>
    </div>
    <div class="col-lg-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <h2 class="h5 text-primary text-uppercase">Atajos r√°pidos</h2>
          <div class="d-flex flex-wrap gap-2">
            <a href="{% url 'historial_servicios' %}" class="btn btn-outline-primary btn-sm">Historial servicios</a>
            <a href="{% url 'indicadores' %}" class="btn btn-outline-primary btn-sm">Indicadores</a>
            <a href="https://youtu.be/9Ga7v2vqans" target="_blank" rel="noopener" class="btn btn-info btn-sm"><i class="fas fa-play me-1"></i>Video capacitaci√≥n</a>
          </div>
          <p class="small text-muted mt-3 mb-0">Consulte los registros previos y analice las fallas reportadas por servicio.</p>
        </div>
      </div>
    </div>
  </div>

  <div class="accordion" id="accordionRondas">
    {% for category in categories %}
      <div class="accordion-item mb-3 border-0 shadow-sm rounded-3 overflow-hidden">
        <h2 class="accordion-header" id="heading-{{ category.clave }}">
          <button
            class="accordion-button {% if not forloop.first %}collapsed{% endif %}"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapse-{{ category.clave }}"
            aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}"
            aria-controls="collapse-{{ category.clave }}"
          >
            <div class="d-flex align-items-center w-100">
              <i class="fas {{ category.icono }} fa-lg me-3 text-primary"></i>
              <div class="flex-grow-1">
                <div class="fw-bold">{{ category.nombre }}</div>
                <small class="text-muted">{{ category.descripcion }}</small>
              </div>
              <span class="badge bg-primary ms-2">{{ category.servicios|length }} servicio{{ category.servicios|length|pluralize }}</span>
            </div>
          </button>
        </h2>
        <div
          id="collapse-{{ category.clave }}"
          class="accordion-collapse collapse {% if forloop.first %}show{% endif %}"
          aria-labelledby="heading-{{ category.clave }}"
          data-bs-parent="#accordionRondas"
        >
          <div class="accordion-body">
            <div class="row g-3">
              {% for sub in category.servicios %}
                <div class="col-lg-6">
                  <div class="card h-100 border-0 shadow-sm">
                    <div class="card-header bg-light border-0">
                      <h5 class="card-title mb-0 text-primary">
                        <i class="fas fa-hospital me-2"></i>{{ sub.servicio }}
                      </h5>
                    </div>
                    <div class="card-body">
                      <form method="post" class="ronda-form">
                        {% csrf_token %}
                        {{ sub.form.usuario }}
                        {{ sub.form.categoria }}
                        {{ sub.form.subservicio }}
                        {{ sub.form.tipo_formulario }}

                        <div class="row g-3">
                          <div class="col-12">
                            <label class="form-label">Hallazgo encontrado</label>
                            {{ sub.form.hallazgo }}
                          </div>

                          <div class="col-md-6">
                            <label class="form-label">Placa del equipo</label>
                            {{ sub.form.placa_equipo }}
                          </div>

                          <div class="col-md-6">
                            <label class="form-label">Orden de trabajo</label>
                            {{ sub.form.orden_trabajo }}
                          </div>

                          <div class="col-12">
                            <div class="form-check">
                              {{ sub.form.fuera_de_servicio }}
                              <label class="form-check-label" for="{{ sub.form.fuera_de_servicio.id_for_label }}">
                                ¬øEquipo fuera de servicio?
                              </label>
                            </div>
                          </div>

                          <div class="col-12">
                            <div class="form-group">
                              <label class="form-label">¬øHay eventos de seguridad?</label>
                              <div class="form-check">
                                <input type="radio" class="form-check-input" name="{{ sub.form.tiene_eventos_seguridad.name }}" value="True" id="{{ sub.form.tiene_eventos_seguridad.id_for_label }}_si">
                                <label class="form-check-label" for="{{ sub.form.tiene_eventos_seguridad.id_for_label }}_si">S√≠</label>
                              </div>
                              <div class="form-check">
                                <input type="radio" class="form-check-input" name="{{ sub.form.tiene_eventos_seguridad.name }}" value="False" id="{{ sub.form.tiene_eventos_seguridad.id_for_label }}_no" checked>
                                <label class="form-check-label" for="{{ sub.form.tiene_eventos_seguridad.id_for_label }}_no">No</label>
                              </div>
                            </div>
                          </div>

                          <div class="col-12">
                            <label class="form-label">Descripci√≥n de eventos de seguridad</label>
                            {{ sub.form.eventos_seguridad }}
                          </div>

                          <div class="col-md-6">
                            <label class="form-label">Nombre encargado del servicio</label>
                            {{ sub.form.nombre_encargado_servicio }}
                          </div>

                          <div class="col-md-6">
                            <label class="form-label">Nombre encargado de la ronda</label>
                            {{ sub.form.nombre_encargado_ronda }}
                          </div>

                          <div class="col-md-6">
                            <label class="form-label">Firma encargado del servicio</label>
                            <canvas width="300" height="100" style="border:1px solid #000; background:#fff;" class="mb-2" id="canvas_servicio_{{ forloop.counter }}"></canvas>
                            <div>
                              <button type="button" class="btn btn-outline-secondary btn-sm mb-2" onclick="guardarFirma('canvas_servicio_{{ forloop.counter }}', '{{ sub.form.firma_servicio.auto_id }}')">Firmar</button>
                              <button type="button" class="btn btn-outline-danger btn-sm mb-2" onclick="limpiarFirma('canvas_servicio_{{ forloop.counter }}')">üóëÔ∏è Limpiar</button>
                            </div>
                            {{ sub.form.firma_servicio }}
                          </div>

                          <div class="col-md-6">
                            <label class="form-label">Firma encargado de la ronda</label>
                            <canvas width="300" height="100" style="border:1px solid #000; background:#fff;" class="mb-2" id="canvas_ronda_{{ forloop.counter }}"></canvas>
                            <div>
                              <button type="button" class="btn btn-outline-secondary btn-sm mb-2" onclick="guardarFirma('canvas_ronda_{{ forloop.counter }}', '{{ sub.form.firma_ronda.auto_id }}')">Firmar</button>
                              <button type="button" class="btn btn-outline-danger btn-sm mb-2" onclick="limpiarFirma('canvas_ronda_{{ forloop.counter }}')">üóëÔ∏è Limpiar</button>
                            </div>
                            {{ sub.form.firma_ronda }}
                          </div>

                          <div class="col-12">
                            <div class="form-check">
                              {{ sub.form.sin_novedad }}
                              <label class="form-check-label" for="{{ sub.form.sin_novedad.id_for_label }}">
                                Sin novedad
                              </label>
                            </div>
                          </div>
                        </div>

                        <div class="mt-3 d-flex gap-2">
                          <button type="button" class="btn btn-warning" data-action="fuera-servicio" title="Marcar equipo como fuera de servicio">
                            üîß Equipo fuera de servicio
                          </button>
                          <button type="submit" class="btn btn-primary">Guardar registro</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <script>
    // Funciones de firma b√°sicas
    function initCanvas(canvasId) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      let drawing = false;
      
      // Limpiar canvas
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      function startDrawing(e) {
        drawing = true;
        draw(e);
      }
      
      function draw(e) {
        if (!drawing) return;
        
        const rect = canvas.getBoundingClientRect();
        let x, y;
        
        if (e.touches) {
          x = e.touches[0].clientX - rect.left;
          y = e.touches[0].clientY - rect.top;
        } else {
          x = e.clientX - rect.left;
          y = e.clientY - rect.top;
        }
        
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000000';
        
        ctx.lineTo(x, y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x, y);
      }
      
      function stopDrawing() {
        if (drawing) {
          drawing = false;
          ctx.beginPath();
        }
      }
      
      // Mouse events
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);
      
      // Touch events
      canvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
        startDrawing(e);
      });
      canvas.addEventListener('touchmove', function(e) {
        e.preventDefault();
        draw(e);
      });
      canvas.addEventListener('touchend', function(e) {
        e.preventDefault();
        stopDrawing();
      });
    }

    function limpiarFirma(canvasId) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function guardarFirma(canvasId, inputId) {
      const canvas = document.getElementById(canvasId);
      const input = document.getElementById(inputId);
      
      if (!canvas || !input) {
        alert('Error: Canvas o campo de firma no encontrado');
        return false;
      }
      
      const dataURL = canvas.toDataURL('image/png');
      if (dataURL.length < 1000) {
        alert('Por favor, dibuje su firma antes de guardar');
        return false;
      }
      
      input.value = dataURL;
      canvas.style.borderColor = '#28a745';
      setTimeout(() => {
        canvas.style.borderColor = '#6c757d';
      }, 2000);
      
      return true;
    }

    // Inicializar todos los canvas
    document.addEventListener('DOMContentLoaded', function() {
      const canvases = document.querySelectorAll('canvas[id^="canvas_"]');
      canvases.forEach(canvas => {
        initCanvas(canvas.id);
      });
      
      // Manejar bot√≥n "Equipo fuera de servicio"
      document.querySelectorAll('[data-action="fuera-servicio"]').forEach(button => {
        button.addEventListener('click', function() {
          const form = this.closest('form');
          const hallazgoField = form.querySelector('textarea[name$="hallazgo"]');
          const fueraServicioField = form.querySelector('input[name$="fuera_de_servicio"]');
          
          if (hallazgoField) {
            hallazgoField.value = 'Equipo fuera de servicio - requiere mantenimiento correctivo';
          }
          if (fueraServicioField) {
            fueraServicioField.checked = true;
          }
          
          alert('Formulario configurado para "Equipo fuera de servicio"');
        });
      });
    });
  </script>
{% endblock %}